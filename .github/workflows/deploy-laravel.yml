name: Deploy Backend to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_PATH: /home/ubuntu/nafa-staff/nafa_personel_back

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            echo "ğŸš€ Starting backend deployment..."

            cd ${{ env.APP_PATH }} || { echo "âŒ Failed to cd into ${{ env.APP_PATH }}"; exit 1; }

            echo "ğŸ”§ Enabling maintenance mode..."
            php artisan down --retry=60 || true

            echo "ğŸ“¥ Pulling latest changes from main..."
            git pull origin main

            echo "ğŸ§½ Clearing bootstrap cache files..."
            rm -f bootstrap/cache/*.php || true

            echo "ğŸ“¦ Installing composer dependencies (no-dev)..."
            if ! composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev; then
              echo "âš ï¸ composer install failed. Doing a clean vendor reinstall..."
              rm -rf vendor
              composer clear-cache || true
              composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            fi

            echo "ğŸ” Rebuilding optimized autoload..."
            composer dump-autoload -o

            echo "ğŸ“¦ Discovering packages..."
            php artisan package:discover --ansi || true

            echo "ğŸ” Checking PHP MySQL driver..."
            if ! php -m | grep -q pdo_mysql; then
              echo "âŒ Missing PHP extension: pdo_mysql"
              echo "â¡ï¸ Install it on server: sudo apt-get install -y php8.2-mysql && restart php-fpm/nginx/apache"
              php artisan up || true
              exit 1
            fi

            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force

            echo "ğŸ§¹ Clearing and caching config/routes/views..."
            php artisan optimize:clear || true
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true

            echo "ğŸ” Setting permissions..."
            sudo chown -R ubuntu:www-data storage bootstrap/cache || true
            chmod -R 775 storage bootstrap/cache || true

            echo "ğŸ” Restarting queue workers (if applicable)..."
            php artisan queue:restart || true

            echo "âœ… Disabling maintenance mode..."
            php artisan up || true

            php artisan serve --port=8000 &
            echo "âœ… Deployment completed successfully!"

      - name: Deployment Status
        if: success()
        run: echo "ğŸš€ Application deployed successfully to server!"

      - name: Deployment Failed (bring app back up)
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "âŒ Deployment failed!"
            echo "ğŸ›Ÿ Attempting to bring the application back up..."
            cd /home/ubuntu/nafa-staff/nafa_personel_back || exit 0
            php artisan up || true
