name: Deploy Backend to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_PATH: /home/ubuntu/nafa-staff/nafa_personel_back

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting backend deployment..."

            cd ${{ env.APP_PATH }} || { echo "âŒ Failed to cd into ${{ env.APP_PATH }}"; exit 1; }

            echo "ğŸ”§ Enabling maintenance mode..."
            php artisan down --message="Deploying updates..." --retry=60 || true

            echo "ğŸ“¥ Pulling latest changes from main..."
            git pull origin main || { echo "âŒ git pull failed"; php artisan up || true; exit 1; }

            echo "ğŸ“¦ Installing composer dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev || { echo "âŒ composer install failed"; php artisan up || true; exit 1; }

            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force || { echo "âŒ migrations failed"; php artisan up || true; exit 1; }

            echo "ğŸ§¹ Clearing and caching config..."
            php artisan config:clear
            php artisan config:cache

            echo "ğŸ›£ï¸ Clearing and caching routes..."
            php artisan route:clear
            php artisan route:cache

            echo "ğŸ–¼ï¸ Clearing and caching views..."
            php artisan view:clear
            php artisan view:cache

            echo "ğŸ§½ Clearing application cache..."
            php artisan cache:clear

            echo "ğŸ” Setting permissions..."
            sudo chown -R ubuntu:www-data storage bootstrap/cache || { echo "âŒ chown failed"; php artisan up || true; exit 1; }
            chmod -R 775 storage bootstrap/cache || { echo "âŒ chmod failed"; php artisan up || true; exit 1; }

            echo "ğŸ” Restarting queue workers (if applicable)..."
            php artisan queue:restart || true

            echo "âœ… Disabling maintenance mode..."
            php artisan up || true

            echo "âœ… Deployment completed successfully!"

      - name: Deployment Status
        if: success()
        run: echo "ğŸš€ Application deployed successfully to server!"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ›Ÿ Attempting to bring the application back up..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd /home/ubuntu/nafa-staff/nafa_personel_back
            php artisan up || true
          ENDSSH
